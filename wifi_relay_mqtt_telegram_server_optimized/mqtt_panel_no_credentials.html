<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MQTT Panel</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  body {
    font-family: Arial;
    text-align: center;
    margin-top: 40px;
    background: white;
  }
  h2 {margin-bottom: 30px;}
  .btn {
    font-size: 18px;
    padding: 15px 40px;
    margin: 12px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    background: #2196F3;
    color: white;
  }
  #statusBox, #timersBox {
    margin-top: 30px;
    padding: 15px;
    font-size: 20px;
    background: white;
    display: inline-block;
    border-radius: 10px;
    min-width: 300px;
  }
</style>
</head>

<body>
<h2>MQTT Controller</h2>
<h3>Main control</h3>
<button class="btn" onclick="send('POWER ON 1')">POWER ON 1</button>
<button class="btn" onclick="send('POWER ON 2')">POWER ON 2</button><br>
<button class="btn" onclick="send('POWER OFF 1')">POWER OFF 1</button>
<button class="btn" onclick="send('POWER OFF 2')">POWER OFF 2</button><br>

<h3>Timers control</h3>
<select id="timerSelector">
  <option value="T1">Timer 1</option>
  <option value="T2">Timer 2</option>
</select>
<br><br>
<input id="timeOn"  type="text" placeholder="Start hh:mm" maxlength="5" oninput="validateTime(this)">
<br><br>
<input id="timeOff" type="text" placeholder="Stop hh:mm" maxlength="5" oninput="validateTime(this)">
<br><br>
<button class="btn" onclick="setTimer()">SET</button>
<button class="btn" onclick="stopTimer()">TOOGLE</button>
<button class="btn" onclick="send('TOOGLE RANDOM')">RANDOM</button><br>
<div id="statusBox">STATUS:</div><br>

<script>
  // ---------------------------------------------------------
  // MQTT credentials
  // ---------------------------------------------------------
  const MQTT_USER     = "";
  const MQTT_PASSWORD = "";
  const MQTT_WS_URL   = ""; 
  // ---------------------------------------------------------

  const client = mqtt.connect(MQTT_WS_URL, {
    username: MQTT_USER,
    password: MQTT_PASSWORD
  });

  client.on("connect", () => {
    console.log("Connected to MQTT");
    client.subscribe("esp8266/status");
    document.getElementById("statusBox").innerText =
      "STATUS: connected";
  });

  client.on("message", (topic, message) => {
    if (topic === "esp8266/status") {
      let st = JSON.parse(message.toString());
      const r1 = (st.relay1 == 1) ? "ON" : "OFF";
      const r2 = (st.relay2 == 1) ? "ON" : "OFF";
      const t1_active = (st.timer1_on_active || st.timer1_off_active) ? "ON" : "OFF";
      const t2_active = (st.timer2_on_active || st.timer2_off_active) ? "ON" : "OFF";

      let line1 = 
      "Relay 1: " +r1 +" | Timer 1 " +t1_active +" " +st.t1_on +"-" +st.t1_off;
      if (st.t1_on_random && st.t1_off_random) { line1 += " | Random " +st.t1_on_random +"-" +st.t1_off_random; }
      let line2 = 
      "Relay 2: " +r2 +" | Timer 2 " +t2_active +" " +st.t2_on +"-" +st.t2_off;
      if (st.t2_on_random && st.t2_off_random) { line2 += " | Random " +st.t2_on_random +"-" +st.t2_off_random; }
      document.getElementById("statusBox").innerText = line1 +"\n" +line2;
    }
  });

  function validateTime(input) {
    let v = input.value;
    v = v.replace(/[^0-9:]/g, "");
    if (v.length === 2 && !v.includes(":")) v += ":";
    if (v.length > 5) v = v.substring(0,5);
    input.value = v;
  }

  // -----------------------------------------------
  // Relay Commands
  // -----------------------------------------------
  function send(cmd) {
    client.publish("esp8266/cmd", cmd);
  }

  // -----------------------------------------------
  // Timer commands
  // -----------------------------------------------
  function setTimer() {
    const timer = document.getElementById("timerSelector").value;
    const timer_on  = document.getElementById("timeOn").value;
    const timer_off = document.getElementById("timeOff").value

    if (!/^(?:[01]\d|2[0-3]):[0-5]\d$/.test(timer_on)) { alert("Invalid format."); return; }
    if (!/^(?:[01]\d|2[0-3]):[0-5]\d$/.test(timer_off)) { alert("Invalid format."); return; }

    send("SET " +timer +" ON " +timer_on);
    send("SET " +timer +" OFF " +timer_off);
  }
  function stopTimer() {
    const timer = document.getElementById("timerSelector").value;
    send("TOOGLE " +timer);
  }
</script>
</body>
</html>